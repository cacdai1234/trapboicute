<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Y√™u c·∫ßu truy c·∫≠p</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: linear-gradient(to bottom, #1e3c72, #2a5298);
      font-family: 'Segoe UI', sans-serif;
      display: flex; justify-content: center; align-items: center;
      color: white; text-align: center; overflow: hidden;
      user-select: none;
      flex-direction: column;
      padding: 20px;
    }
    #requestAccessBtn {
      padding: 12px 25px;
      background: #fcd34d;
      border: none;
      border-radius: 10px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 0 10px #fcd34daa;
      transition: background 0.3s ease;
      margin-bottom: 15px;
    }
    #requestAccessBtn:hover {
      background: #facc15;
    }
    #notification {
      min-height: 22px;
      font-size: 1.1rem;
      color: #fcd34d;
      margin-bottom: 20px;
    }
    #content {
      display: none;
      max-width: 500px;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      color: white;
      user-select: text;
      position: relative;
      text-align: left;
      line-height: 1.6;
    }
    #content h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: #fcd34d;
      text-align: center;
    }
    #content p {
      font-size: 1.2rem;
      white-space: pre-line;
    }
    .heart {
      font-size: 2rem;
      margin-top: 1rem;
      animation: beat 1.2s infinite;
      color: #f43f5e;
      text-align: center;
    }
    @keyframes beat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    /* ·∫¢nh nh·ªè g√≥c ph·∫£i */
    #smallImage {
      position: fixed;
      bottom: 15px;
      right: 15px;
      width: 80px;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 0 8px #0008;
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
      z-index: 1000;
    }
    /* Admin Panel */
    #adminPanel {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.85);
      border: 2px solid #fcd34d;
      border-radius: 10px;
      padding: 15px;
      width: 320px;
      max-height: 80vh;
      overflow-y: auto;
      color: #fcd34d;
      font-size: 14px;
      display: none;
      z-index: 2000;
      user-select: text;
    }
    #adminPanel h2 {
      margin-top: 0;
      font-size: 20px;
      text-align: center;
      margin-bottom: 10px;
    }
    #adminPanel table {
      width: 100%;
      border-collapse: collapse;
    }
    #adminPanel th, #adminPanel td {
      border: 1px solid #fcd34d;
      padding: 6px 8px;
      text-align: center;
    }
    #adminPanel button.approveBtn {
      background: #fcd34d;
      border: none;
      color: black;
      font-weight: bold;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #adminPanel button.approveBtn:hover {
      background: #facc15;
    }
  </style>
</head>
<body>

  <button id="requestAccessBtn">Y√äU C·∫¶U QUY·ªÄN TRUY C·∫¨P</button>
  <div id="notification"></div>

  <div id="content">
    <h1>Anh xin l·ªói...</h1>
    <p>
      Anh xin l·ªói v√¨ chuy·ªán h√¥m n·ªç nh√©. Anh kh√¥ng c·ªë √Ω ƒë√¢u, t·∫°i anh v√¥ t√¢m qu√°. Mong em ƒë·ª´ng bu·ªìn n·ªØa nha!<br>
      Anh xin l·ªói v√¨ ƒë√£ l√†m em bu·ªìn. Anh nh·∫≠n bi·∫øt ƒë∆∞·ª£c ƒëi·ªÅu ƒë√≥ l√† sai r·ªìi ..!
    </p>
    <div class="heart">üíî</div>
  </div>

  <img id="smallImage" src="https://i.postimg.cc/cHZhT8zk/5-2-1.png" alt="Game Image" />

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel - Danh s√°ch y√™u c·∫ßu</h2>
    <table>
      <thead>
        <tr>
          <th>IP</th>
          <th>Th·ªùi gian</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="requestsTableBody"></tbody>
    </table>
    <p><i>Nh·∫•n ph√≠m P ƒë·ªÉ ·∫©n/hi·ªán b·∫£ng n√†y</i></p>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCtJtabQIwEl_lUO8vIpeQgp4OyMtcXjkw",
      authDomain: "login-a2878.firebaseapp.com",
      databaseURL: "https://login-a2878-default-rtdb.firebaseio.com",
      projectId: "login-a2878",
      storageBucket: "login-a2878.firebasestorage.app",
      messagingSenderId: "312148809641",
      appId: "1:312148809641:web:c77b295ada290ecc9156b8",
      measurementId: "G-7DRBRBRJHL"
    };

    const webhookURL = "https://discord.com/api/webhooks/1377288272681762987/jN32jNiowBMlbr8LPOLG_HqthF1_epQKoSKG0pHTLr9glr1fVp342oAO1K-JH0I8VyT8";

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const requestAccessBtn = document.getElementById('requestAccessBtn');
    const notification = document.getElementById('notification');
    const content = document.getElementById('content');
    const smallImage = document.getElementById('smallImage');

    const adminPanel = document.getElementById('adminPanel');
    const requestsTableBody = document.getElementById('requestsTableBody');

    let userIp = null;
    let approved = false;
    let imageTimeout;

    async function getUserIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        return data.ip;
      } catch {
        return null;
      }
    }

    function sendWebhook(ip) {
      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: `üîî Y√™u c·∫ßu truy c·∫≠p m·ªõi t·ª´ IP: ${ip}`
        }),
      });
    }

    function sendRequest(ip) {
      const requestRef = db.ref('requests/' + ip);
      requestRef.set({
        ip: ip,
        timestamp: Date.now()
      });
    }

    function showContent() {
      content.style.display = 'block';
      requestAccessBtn.style.display = 'none';
      notification.textContent = "";

      clearTimeout(imageTimeout);
      smallImage.style.opacity = '1';
      imageTimeout = setTimeout(() => {
        smallImage.style.opacity = '0';
      }, 5000);
    }

    async function listenApproval(ip) {
      if (!ip) return;
      db.ref('approved/' + ip).on('value', snapshot => {
        if (snapshot.exists()) {
          approved = true;
          showContent();
          notification.textContent = "B·∫°n ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát!";
        }
      });
    }

    requestAccessBtn.onclick = async () => {
      notification.textContent = "";
      userIp = await getUserIP();
      if (!userIp) {
        notification.textContent = "Kh√¥ng l·∫•y ƒë∆∞·ª£c IP, vui l√≤ng th·ª≠ l·∫°i.";
        return;
      }

      // Ki·ªÉm tra n·∫øu ƒë√£ duy·ªát r·ªìi th√¨ hi·ªán n·ªôi dung lu√¥n, kh√¥ng g·ª≠i webhook n·ªØa
      const approvedSnap = await db.ref('approved/' + userIp).once('value');
      if (approvedSnap.exists()) {
        approved = true;
        showContent();
        notification.textContent = "B·∫°n ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát!";
        listenApproval(userIp);
        return;
      }

      // G·ª≠i y√™u c·∫ßu m·ªõi
      sendRequest(userIp);

      // G·ª≠i webhook ch·ªâ khi ch∆∞a duy·ªát
      sendWebhook(userIp);

      notification.textContent = "Y√™u c·∫ßu ƒë√£ g·ª≠i, vui l√≤ng ch·ªù ph√™ duy·ªát.";
      listenApproval(userIp);
    };

    (async () => {
      userIp = await getUserIP();
      if (!userIp) return;
      const approvedSnap = await db.ref('approved/' + userIp).once('value');
      if (approvedSnap.exists()) {
        approved = true;
        showContent();
      }
      listenApproval(userIp);
    })();

    // Admin panel toggle b·∫±ng ph√≠m P
    window.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 'p') {
        adminPanel.style.display = adminPanel.style.display === 'block' ? 'none' : 'block';
        if (adminPanel.style.display === 'block') {
          loadRequests();
        }
      }
    });

    // Load danh s√°ch y√™u c·∫ßu t·ª´ Firebase
    function loadRequests() {
      requestsTableBody.innerHTML = '';
      db.ref('requests').once('value').then(snapshot => {
        const requests = snapshot.val();
        if (!requests) {
          requestsTableBody.innerHTML = '<tr><td colspan="3">Kh√¥ng c√≥ y√™u c·∫ßu n√†o</td></tr>';
          return;
        }

        // L·∫•y danh s√°ch approved ƒë·ªÉ kh√¥ng show IP ƒë√£ duy·ªát
        db.ref('approved').once('value').then(approvedSnap => {
          const approvedIPs = approvedSnap.val() || {};

          Object.entries(requests).forEach(([ip, data]) => {
            if (approvedIPs[ip]) return; // B·ªè qua IP ƒë√£ duy·ªát

            const tr = document.createElement('tr');

            const tdIp = document.createElement('td');
            tdIp.textContent = ip;

            const tdTime = document.createElement('td');
            const timeStr = new Date(data.timestamp).toLocaleString('vi-VN');
            tdTime.textContent = timeStr;

            const tdAction = document.createElement('td');
            const approveBtn = document.createElement('button');
            approveBtn.textContent = 'Ph√™ duy·ªát';
            approveBtn.className = 'approveBtn';
            approveBtn.onclick = () => approveIp(ip);
            tdAction.appendChild(approveBtn);

            tr.appendChild(tdIp);
            tr.appendChild(tdTime);
            tr.appendChild(tdAction);

            requestsTableBody.appendChild(tr);
          });

          // N·∫øu kh√¥ng c√≤n IP ch·ªù
          if (requestsTableBody.children.length === 0) {
            requestsTableBody.innerHTML = '<tr><td colspan="3">Kh√¥ng c√≥ y√™u c·∫ßu n√†o</td></tr>';
          }
        });
      });
    }

    // Duy·ªát IP
    function approveIp(ip) {
      db.ref('approved/' + ip).set(true)
        .then(() => {
          alert(`ƒê√£ ph√™ duy·ªát IP: ${ip}`);
          loadRequests();
        })
        .catch(err => {
          alert('L·ªói khi ph√™ duy·ªát: ' + err.message);
        });
    }
  </script>

</body>
</html>
